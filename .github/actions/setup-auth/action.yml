name: 'Setup and Authentication'
author: '@MassimilianoDH'
description: 'Setup Terraform and Authenticate to Cloud'
inputs:
  ssh-key:
    description: 'SSH key to access private Git repositories'
    required: false
  gcp-credentials:
    description: 'JSON key generated by Google Cloud Service Account'
    required: false
  azr-credentials:
    description: 'Credentials generated by Azure CLI'
    required: false
  aws-credentials:
    description: 'AWS Credentials'
    required: false
  aws-region:
    description: 'AWS Region'
    required: false
runs:
  using: 'composite'
  steps:
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Verify Terraform Version
      shell: bash
      run: terraform --version

    # Needed for private Git repositories.
    # https://github.com/webfactory/ssh-agent
    - name: Setup SSH for Terraform Modules
      uses: webfactory/ssh-agent@v0.5.4
      with:
        ssh-private-key: ${{ inputs.ssh-key }}
  
    # Needed for GCP remote backend.
    # GCP Auth: https://github.com/google-github-actions/auth
    - name: GCP Auth
      uses: google-github-actions/auth@v0
      with:
        credentials_json: ${{ inputs.gcp-credentials }}

    - name: Set up Cloud SDK with CI Credentials
      uses: google-github-actions/setup-gcloud@v0

    # Needed for Azure remote backend.
    # Azure Login: https://github.com/Azure/login
    - name: AZ Auth
      uses: azure/login@v1
      with:
        creds: ${{ inputs.azr-credentials }}

    # Needed for AWS remote backend.    
    # AWS Credentials: https://github.com/aws-actions/configure-aws-credentials
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{ inputs.aws-credentials }}
        aws-region: ${{ inputs.aws-credentials }}